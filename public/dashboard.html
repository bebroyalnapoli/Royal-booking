<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Royal Booking</title>
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script src="auth.js"></script>
</head>

<body onload="loadDashboard()">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">

    <!-- Bombatura in alto -->
    <div class="sidebar-toggle" onclick="toggleSidebar()">
      <span id="toggleArrow">â†</span>
    </div>

    <h2>Royal Booking</h2>

    <div class="menu">
      <a class="active" href="dashboard.html" data-label="Dashboard">ğŸ  <span>Dashboard</span></a>
      <a href="stanze.html" data-label="Stanze">ğŸ›ï¸ <span>Stanze</span></a>
      <a href="prenotazioni.html" data-label="Prenotazioni">ğŸ“… <span>Prenotazioni</span></a>
      <a href="strutture.html" data-label="Strutture">ğŸ¢ <span>Strutture</span></a>
      <a href="#" data-label="Impostazioni">âš™ï¸ <span>Impostazioni</span></a>
    </div>

    <div class="logout-btn" onclick="logoutUser()">ğŸšª Logout</div>
  </div>

  <!-- PAGE CONTENT -->
  <div class="page-content" id="pageContent">

    <!-- HEADER CON SELEZIONE STRUTTURA -->
    <div class="page-header">
      <h1>Dashboard</h1>
      <select id="structureSelector" onchange="changeStructure()">
        <option value="default">Seleziona struttura</option>
        <!-- Le strutture verranno caricate dinamicamente -->
      </select>
    </div>

    <!-- CARD METRICHE -->
    <div class="dashboard-grid">

      <div class="dash-card">
        <div class="dash-icon">ğŸ“…</div>
        <div class="dash-info">
          <h2>Prenotazioni totali</h2>
          <p id="totalBookings">0</p>
        </div>
      </div>

      <div class="dash-card">
        <div class="dash-icon">ğŸ›ï¸</div>
        <div class="dash-info">
          <h2>Stanze totali</h2>
          <p id="totalRooms">0</p>
        </div>
      </div>

      <div class="dash-card">
        <div class="dash-icon">ğŸ¢</div>
        <div class="dash-info">
          <h2>Strutture</h2>
          <p id="totalStructures">0</p>
        </div>
      </div>

      <div class="dash-card wide">
        <div class="dash-icon">ğŸ“Š</div>
        <div class="dash-info">
          <h2>Occupazione media</h2>
          <p id="avgOccupancy">0%</p>
        </div>
      </div>

    </div>

  </div>

  <!-- SCRIPT SIDEBAR -->
  <script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    const content = document.getElementById("pageContent");
    const arrow = document.getElementById("toggleArrow");

    sidebar.classList.toggle("collapsed");
    content.classList.toggle("expanded");

    arrow.textContent = sidebar.classList.contains("collapsed") ? "â†’" : "â†";
  }
  </script>

  <!-- FIRESTORE SCRIPT -->
  <script>
  const db = firebase.firestore();
  let currentUser = null;
  let activeStructure = null;

  function loadDashboard() {
    checkAuth();

    firebase.auth().onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        loadStructures();
      }
    });
  }

  function loadStructures() {
    db.collection("strutture")
      .where("owner", "==", currentUser.uid)
      .get()
      .then(snapshot => {
        const selector = document.getElementById("structureSelector");
        snapshot.forEach(doc => {
          const option = document.createElement("option");
          option.value = doc.id;
          option.textContent = doc.data().nome || "Struttura";
          selector.appendChild(option);
        });
      });
  }

  function changeStructure() {
    const selector = document.getElementById("structureSelector");
    activeStructure = selector.value;
    loadCounts();
  }

  function loadCounts() {
    if (!activeStructure || activeStructure === "default") return;

    // Prenotazioni
    db.collection("prenotazioni")
      .where("owner", "==", currentUser.uid)
      .where("structureId", "==", activeStructure)
      .get()
      .then(snap => {
        document.getElementById("totalBookings").textContent = snap.size;
      });

    // Stanze
    db.collection("stanze")
      .where("owner", "==", currentUser.uid)
      .where("structureId", "==", activeStructure)
      .get()
      .then(snap => {
        document.getElementById("totalRooms").textContent = snap.size;
      });

    // Strutture
    document.getElementById("totalStructures").textContent = "1";

    // Occupazione media (placeholder)
    document.getElementById("avgOccupancy").textContent = "0%";
  }
  </script>

</body>
</html>
