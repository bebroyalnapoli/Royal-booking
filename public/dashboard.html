<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Dashboard - Royal Booking</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f172a">

  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- App JS -->
  <script src="firebase.js"></script>
  <script src="auth.js"></script>
  <script src="sidebar.js"></script>
</head>

<body>

  <!-- SIDEBAR -->
  <div id="sidebar-container"></div>

  <!-- HEADER DASHBOARD -->
  <header class="dashboard-header">
    <button class="menu-btn" onclick="document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show');">
      ☰
    </button>

    <h1>ROYAL BOOKING</h1>

    <div class="struttura-attiva" onclick="document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show');">
      <span id="nomeStruttura">Nessuna struttura selezionata</span>
    </div>
  </header>

  <!-- CONTENUTO -->
  <main class="page-content">

    <div id="noStruttura" class="warning hidden">
      ⚠️ Seleziona una struttura dal menu
    </div>

    <!-- KPI GRID -->
    <section id="dashboardGrid" class="dashboard-grid hidden">

      <div class="dash-card">
        <h3>STRUTTURE</h3>
        <p id="kpiStrutture">0</p>
      </div>

      <div class="dash-card">
        <h3>OCCUPAZIONE</h3>
        <p id="kpiOccupazione">0%</p>
      </div>

      <div class="dash-card">
        <h3>CHECK-IN</h3>
        <p id="kpiCheckin">0</p>
      </div>

      <div class="dash-card">
        <h3>CHECK-OUT</h3>
        <p id="kpiCheckout">0</p>
      </div>

    </section>

  </main>

  <!-- LOGICA DASHBOARD -->
  <script>

    async function loadDashboard() {

      const strutturaId = localStorage.getItem("strutturaAttiva");

      if (!strutturaId) {
        document.getElementById("noStruttura").classList.remove("hidden");
        return;
      }

      document.getElementById("dashboardGrid").classList.remove("hidden");

      // Nome struttura attiva
      const strutturaDoc = await db.collection("strutture").doc(strutturaId).get();
      if (strutturaDoc.exists) {
        document.getElementById("nomeStruttura").innerText =
          strutturaDoc.data().nome;
      }

      // Totale strutture account
      const struttureSnap = await db.collection("strutture").get();
      document.getElementById("kpiStrutture").innerText =
        struttureSnap.size;

      // Prenotazioni della struttura
      const prenotazioniSnap = await db.collection("prenotazioni")
        .where("strutturaId", "==", strutturaId)
        .get();

      const oggi = new Date().toISOString().split("T")[0];

      let checkinOggi = 0;
      let checkoutOggi = 0;

      prenotazioniSnap.forEach(doc => {
        const p = doc.data();

        if (p.checkin === oggi) checkinOggi++;
        if (p.checkout === oggi) checkoutOggi++;
      });

      document.getElementById("kpiCheckin").innerText = checkinOggi;
      document.getElementById("kpiCheckout").innerText = checkoutOggi;

      // Calcolo occupazione (semplificato)
      const stanzeSnap = await db.collection("stanze")
        .where("strutturaId", "==", strutturaId)
        .get();

      const totaleStanze = stanzeSnap.size || 1;

      let stanzeOccupate = 0;

      prenotazioniSnap.forEach(doc => {
        const p = doc.data();
        if (p.checkin <= oggi && p.checkout >= oggi) {
          stanzeOccupate += (p.stanze || []).length;
        }
      });

      const percentuale = Math.round((stanzeOccupate / totaleStanze) * 100);

      document.getElementById("kpiOccupazione").innerText =
        percentuale + "%";
    }

    // INIT PAGINA
    checkAuth();
    loadSidebar(() => {
      loadDashboard();
    });

  </script>

</body>
</html>