<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Prenotazioni - Royal Booking</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <link rel="stylesheet" href="style.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- Auth -->
  <script src="auth.js"></script>
</head>

<body onload="loadBookingsPage()">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">

    <!-- Linguetta -->
    <div class="sidebar-tab" onclick="toggleSidebar()">
      <span id="toggleArrow">â†</span>
    </div>

    <h2>Royal Booking</h2>

    <!-- Selettore struttura -->
    <div class="structure-selector">
      <label>Struttura</label>
      <select id="structureSelector" onchange="changeStructure()">
        <option value="default">Seleziona struttura</option>
      </select>
    </div>

    <div class="menu">
      <a href="dashboard.html">ğŸ  <span>Dashboard</span></a>
      <a href="stanze.html">ğŸ›ï¸ <span>Stanze</span></a>
      <a class="active" href="prenotazioni.html">ğŸ“… <span>Prenotazioni</span></a>
      <a href="strutture.html">ğŸ¢ <span>Strutture</span></a>
    </div>

    <div class="logout-btn" onclick="logoutUser()">ğŸšª Logout</div>
  </div>

  <!-- CONTENUTO -->
  <div class="page-content" id="pageContent">

    <div class="page-header">
      <h1>Prenotazioni</h1>
    </div>

    <button id="addBookingBtn" style="
      padding: 10px 15px;
      background:#111827;
      color:white;
      border:none;
      border-radius:8px;
      margin-bottom:15px;
      cursor:pointer;
    ">+ Aggiungi prenotazione</button>

    <div id="bookingsList" class="dashboard-grid"></div>

  </div>

  <!-- ===========================
       JAVASCRIPT INTEGRATO
  ============================ -->
  <script>
    const db = firebase.firestore();
    let currentUser = null;
    let activeStructure = null;

    /* -------------------------
       SIDEBAR
    ------------------------- */
    function toggleSidebar() {
      const sidebar = document.getElementById("sidebar");
      const content = document.getElementById("pageContent");
      const arrow = document.getElementById("toggleArrow");

      sidebar.classList.toggle("collapsed");
      content.classList.toggle("expanded");

      arrow.textContent = sidebar.classList.contains("collapsed") ? "â†’" : "â†";
    }

    /* -------------------------
       CARICAMENTO PAGINA
    ------------------------- */
    function loadBookingsPage() {
      checkAuth();

      firebase.auth().onAuthStateChanged(user => {
        if (!user) return;
        currentUser = user;

        loadStructureSelector();
      });
    }

    /* -------------------------
       CARICA STRUTTURE NEL SELECTOR
    ------------------------- */
    function loadStructureSelector() {
      db.collection("strutture")
        .where("owner", "==", currentUser.uid)
        .get()
        .then(snapshot => {
          const selector = document.getElementById("structureSelector");
          selector.innerHTML = `<option value="default">Seleziona struttura</option>`;

          snapshot.forEach(doc => {
            const option = document.createElement("option");
            option.value = doc.id;
            option.textContent = doc.data().nome;
            selector.appendChild(option);
          });

          const saved = localStorage.getItem("activeStructure");
          if (saved) {
            selector.value = saved;
            activeStructure = saved;
            loadBookingsList();
          }
        });
    }

    /* -------------------------
       CAMBIO STRUTTURA
    ------------------------- */
    function changeStructure() {
      activeStructure = document.getElementById("structureSelector").value;
      localStorage.setItem("activeStructure", activeStructure);
      loadBookingsList();
    }

    /* -------------------------
       CARICA PRENOTAZIONI
    ------------------------- */
    function loadBookingsList() {
      if (!activeStructure || activeStructure === "default") return;

      const container = document.getElementById("bookingsList");
      container.innerHTML = "Caricamento...";

      db.collection("prenotazioni")
        .where("owner", "==", currentUser.uid)
        .where("structureId", "==", activeStructure)
        .get()
        .then(snapshot => {
          container.innerHTML = "";

          if (snapshot.empty) {
            container.innerHTML = "<p>Nessuna prenotazione trovata.</p>";
            return;
          }

          snapshot.forEach(doc => {
            const b = doc.data();

            const card = document.createElement("div");
            card.className = "dash-card";
            card.style.cursor = "pointer";

            card.innerHTML = `
              <div class="dash-icon">ğŸ“…</div>
              <div class="dash-info">
                <h2>${b.nomeCliente}</h2>
                <p>${b.checkin} â†’ ${b.checkout}</p>
                <p>Stanza: ${b.stanzaNome || "-"}</p>
              </div>
            `;

            card.onclick = () => {
              window.location.href = "prenotazione_dettaglio.html?id=" + doc.id;
            };

            container.appendChild(card);
          });
        });
    }

    /* -------------------------
       AGGIUNGI PRENOTAZIONE
    ------------------------- */
    document.getElementById("addBookingBtn").addEventListener("click", () => {
      if (!activeStructure || activeStructure === "default") {
        alert("Seleziona prima una struttura");
        return;
      }

      const nomeCliente = prompt("Nome cliente:");
      if (!nomeCliente) return;

      const checkin = prompt("Check-in (YYYY-MM-DD):");
      const checkout = prompt("Check-out (YYYY-MM-DD):");
      const stanza = prompt("Stanza:");

      db.collection("prenotazioni").add({
        nomeCliente,
        checkin,
        checkout,
        stanzaNome: stanza || "",
        owner: currentUser.uid,
        structureId: activeStructure
      }).then(() => {
        loadBookingsList();
      });
    });
  </script>

</body>
</html>
